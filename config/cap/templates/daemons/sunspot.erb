#!/bin/bash

PATH=<%= absolute_path(default_environment["PATH"], user) %>
PIDFILE=<%= "#{shared_path}/pids/sunspot-solr.pid" %>
export RAILS_ENV=production

getPID() {
  if [ ! -z `cat $PIDFILE 2> /dev/null` ]; then
    if [[ ! -z $(ps -ef | grep -w `cat $PIDFILE` | grep -v grep) ]]; then
      echo `cat $PIDFILE 2> /dev/null`
    fi
  fi
}

case "$1" in
  start)
    echo -ne "<%= "Starting #{application}-sunspot..." %>"

    if [ -z "$(getPID)" ]; then
      cd <%=current_path%>
      bundle exec sunspot-solr start --port=<%=sunspot_port%> --data-directory=<%= "#{shared_path}/solr/data" %> --pid-dir=<%= "#{shared_path}/pids" %>

      echo "started!"
    else
      echo "is already running!"
    fi
    ;;

  stop)
    echo -ne "<%= "Stopping #{application}-sunspot..." %>"

    if [ -z "$(getPID)" ]; then
      echo "is not running!"
    else
      cd <%=current_path%>
      bundle exec sunspot-solr stop --port=<%=sunspot_port%> --data-directory=<%= "#{shared_path}/solr/data" %> --pid-dir=<%= "#{shared_path}/pids" %>

      echo "stopped!"
    fi
    ;;

  reindex)
    if [ -z "$(getPID)" ]; then
      echo "<%="#{application}-sunspot is not running!"%>"
    else
      cd <%=current_path%>
      bundle exec rake sunspot:solr:reindex
    fi
    ;;

  restart)
    $0 stop
    $0 start
    ;;

  *)
    echo "usage: $0 {start|stop|restart|reindex}"
esac
exit 0
